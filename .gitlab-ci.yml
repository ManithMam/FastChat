stages:      
  - setup    
  - build
  - test
  - deploy

setup-job:
  image: node:latest
  stage: setup
  script:   
    - npm install --legacy-peer-deps --include=dev
    - npm install vite@latest --save-dev --legacy-peer-deps
    #- ls
    #- cd ./node_modules
    #- ls
  artifacts:
    paths:
      - node_modules
    expire_in: 1h
  only:
    #- develop
    #- main

build-job:     
  image: node:20-alpine3.17
  stage: build 
  script:   
    - npm run build 
  artifacts:
    paths: 
      - dist
    expire_in: 1h
  only:
    #- main

test-job:
  image: node:latest
  stage: test  
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest-8 --activate
    - pnpm config set store-dir .pnpm-store
  script:         
    - apt-get update -qq && apt-get install   
    - apt-get -y install default-jre      
    - npm install -g firebase-tools   
    
    - firebase emulators:exec --project socketchat-7dd2a 'pnpm test'
  only:
    - develop
    #- main

deploy-job:      
  image: node:latest
  stage: deploy  
  environment: production 
  script:          
    - npm install -g firebase-tools    
    - firebase deploy --token $FIREBASE_TOKEN
  only:
    #- main
   
 